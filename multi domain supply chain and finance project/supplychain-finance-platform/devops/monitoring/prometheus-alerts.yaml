apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-alerts
  namespace: supplychain
data:
  alerts.yml: |
    groups:
      - name: SupplyChainPlatform
        rules:
          # Service availability alerts
          - alert: ServiceDown
            expr: up == 0
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "Service {{ $labels.job }} is down"
              description: "Service {{ $labels.job }} has been down for more than 5 minutes"

          # High error rate alerts
          - alert: HighErrorRate
            expr: rate(http_requests_total{status=~"^5..$"}[5m]) / rate(http_requests_total[5m]) > 0.1
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: "High error rate detected"
              description: "Error rate is {{ $value }}% for service {{ $labels.service }}"

          # High response time alerts
          - alert: HighResponseTime
            expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High response time detected"
              description: "95th percentile response time is {{ $value }}s for service {{ $labels.service }}"

          # Database connection pool alerts
          - alert: DatabaseConnectionPoolExhausted
            expr: database_connections_active / database_connections_max > 0.9
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "Database connection pool nearly exhausted"
              description: "Database connection pool usage is {{ $value }}%"

          # Cache hit rate alerts
          - alert: LowCacheHitRate
            expr: cache_hits_total / (cache_hits_total + cache_misses_total) < 0.8
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: "Low cache hit rate"
              description: "Cache hit rate is {{ $value }}% for {{ $labels.cache }}"

          # AI model performance alerts
          - alert: AIModelAccuracyDegraded
            expr: ai_model_accuracy < 0.85
            for: 15m
            labels:
              severity: warning
            annotations:
              summary: "AI model accuracy degraded"
              description: "Model accuracy is {{ $value }} for {{ $labels.model }}"

          # Blockchain alerts
          - alert: BlockchainTransactionFailed
            expr: increase(blockchain_transaction_failures_total[5m]) > 5
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "Multiple blockchain transaction failures"
              description: "{{ $value }} blockchain transactions failed in the last 5 minutes"

          # Resource usage alerts
          - alert: HighCPUUsage
            expr: rate(container_cpu_usage_seconds_total[5m]) > 0.8
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: "High CPU usage"
              description: "CPU usage is {{ $value }}% for {{ $labels.pod }}"

          - alert: HighMemoryUsage
            expr: container_memory_usage_bytes / container_spec_memory_limit_bytes > 0.9
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High memory usage"
              description: "Memory usage is {{ $value }}% for {{ $labels.pod }}"

          # Business metric alerts
          - alert: UnusualInvoiceVolume
            expr: increase(invoices_created_total[1h]) > 1000
            for: 5m
            labels:
              severity: info
            annotations:
              summary: "Unusual invoice creation volume"
              description: "{{ $value }} invoices created in the last hour"

          - alert: PaymentProcessingDelayed
            expr: increase(payment_processing_delayed_total[5m]) > 10
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "Payment processing delays"
              description: "{{ $value }} payments are delayed"

          # Security alerts
          - alert: HighFailedLoginAttempts
            expr: increase(auth_failed_attempts_total[5m]) > 20
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High number of failed login attempts"
              description: "{{ $value }} failed login attempts in 5 minutes from {{ $labels.ip }}"

          # IoT alerts
          - alert: IoTDeviceOffline
            expr: iot_devices_online < 0.8 * iot_devices_total
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: "Multiple IoT devices offline"
              description: "{{ $value }}% of IoT devices are offline"
